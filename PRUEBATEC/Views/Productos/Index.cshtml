@model IEnumerable<PRUEBATEC.Models.ProductoModel>
@{
    ViewData["Title"] = "Lista de Productos";
    var paginaActual = ViewBag.PaginaActual ?? 1;
    var totalPaginas = ViewBag.TotalPaginas ?? 1;
    var busqueda = ViewBag.Busqueda ?? "";
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<form method="get" class="form-inline mb-3">
    <input type="text" name="busqueda" value="@busqueda" class="form-control" placeholder="Buscar..." />
    <button type="submit" class="btn btn-primary">Buscar</button>
</form>

<p>
    <a class="btn btn-success" asp-action="Create">Nuevo Producto</a>
</p>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>
                <a asp-action="Index" asp-route-sortOrder="@ViewData["NombreSortParam"]" asp-route-busqueda="@busqueda">
                    Nombre
                </a>
            </th>
            <th>SKU</th>
            <th>Cantidad</th>
            <th>
                <a asp-action="Index" asp-route-sortOrder="@ViewData["PrecioVSortParam"]" asp-route-busqueda="@busqueda">
                    Precio Venta
                </a>
            </th>
            <th>
                <a asp-action="Index" asp-route-sortOrder="@ViewData["PrecioCSortParam"]" asp-route-busqueda="@busqueda">
                    Precio Costo
                </a>
            </th>
            <th>Última Modificación</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.NombreP</td>
                <td>@item.SKU</td>
                <td>@item.Cantidad</td>
                <td>@item.PrecioV.ToString("C2")</td>
                <td>@item.PrecioC.ToString("C2")</td>
                <td>@item.FechaModificacion.ToString("g")</td>
                <td>
                    <a class="btn btn-sm btn-warning" asp-action="Edit" asp-route-id="@item.Id">Editar</a>
                    <button class="btn btn-sm btn-danger btnEliminar" data-id="@item.Id">Eliminar</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<nav>
    <ul class="pagination">
        @for (int i = 1; i <= totalPaginas; i++)
        {
            <li class="page-item @(i == paginaActual ? "active" : "")">
                <a class="page-link" asp-action="Index" asp-route-pagina="@i" asp-route-busqueda="@busqueda">@i</a>
            </li>
        }
    </ul>
</nav>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Mostrar alertas del controlador
            var alerta = '@TempData["Alerta"]';
            var tipoAlerta = '@TempData["TipoAlerta"]';

            if (alerta && tipoAlerta) {
                Swal.fire({
                    icon: tipoAlerta === 'success' ? 'success' : 'error',
                    title: tipoAlerta === 'success' ? 'Éxito' : 'Error',
                    text: alerta,
                    confirmButtonColor: tipoAlerta === 'success' ? '#3085d6' : '#d33'
                });
            }

            // Confirmación de eliminación
            const botonesEliminar = document.querySelectorAll(".btnEliminar");
            botonesEliminar.forEach(btn => {
                btn.addEventListener("click", function () {
                    var id = this.dataset.id;

                    Swal.fire({
                        title: '¿Eliminar producto?',
                        text: "Esta acción no se puede deshacer.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sí, eliminar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Crear un formulario dinámico para enviar POST
                            const form = document.createElement('form');
                            form.method = 'post';
                            form.action = '@Url.Action("DeleteConfirmed", "Productos")/' + id;

                            // Anti-forgery token
                            const token = document.createElement('input');
                            token.type = 'hidden';
                            token.name = '__RequestVerificationToken';
                            token.value = $('input[name="__RequestVerificationToken"]').val();
                            form.appendChild(token);

                            document.body.appendChild(form);
                            form.submit();
                        }
                    });
                });
            });
        });
    </script>
}
